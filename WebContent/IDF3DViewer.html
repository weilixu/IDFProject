<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title> View IDF 3D Wireframe</title>
<link rel="stylesheet" href="js/jstree/themes/default/style.css" />
<link rel="stylesheet" href="bootstrap/css/bootstrap.css" />
<style type="text/css">
.info_data,
.hvac_sys_info_data {
    cursor: pointer;
}
.view_switch_btn{
    margin: 10px;
}
#inset  {
    width: 100px;
    height: 100px;
    background-color: #fff;
    border: 1px solid black;
    margin: 20px;
    padding: 0px;
    position: absolute;
    left: 0px;
    top: 360px;
    z-index: 100;
}
#load_switch{
    width: 250px;
    position: absolute;
    height:40px;
    top: 50px;
    left: 50px;
    display:none;
}
#solor_adjust{
    width: 250px;
    position: absolute;
    height:40px;
    top: 50px;
    right: 50px;
}
#date_adjust{
    width: 250px;
    position: absolute;
    height:40px;
    top: 10px;
    right: 50px;
}
.table-cell{
    display:table-cell;
    vertical-align: middle;
}
.lengend_cell{
	border: 1px solid black;
	width:80px;
	height:20px;
	opacity: 0.7;
    filter: alpha(opacity=70);
}
#lengend_1{
	background-color: #FF0000;
}
#lengend_2{
	background-color: #E11E00;
}
#lengend_3{
	background-color: #C33C00;
}
#lengend_4{
	background-color: #A55A00;
}
#lengend_5{
	background-color: #877800;
}
#lengend_6{
	background-color: #699600;
}
#lengend_7{
	background-color: #4BB400;
}
#lengend_8{
	background-color: #2DD200;
}
#lengend_9{
	background-color: #0FF000;
}
#lengend_10{
	background-color: #00FF00;
}
#red_value,
#green_value{
	padding-left:10px;
}
label{
	margin-bottom: -5px;
    margin-left: 5px;
    cursor: pointer;
    font-weight: normal;
}
</style>
</head>
<body>
<div id='geometry_wrapper' style="overflow:hidden;height:500px;cursor:default;">
    <canvas id="geometry"></canvas>
</div>
<div id="date_adjust">
    <div class="table-cell">Month:</div>
    <div class="table-cell">
        <select id="month_list">
            <option value="1">Jan</option>
            <option value="2">Feb</option>
            <option value="3">Mar</option>
            <option value="4">Apr</option>
            <option value="5">May</option>
            <option value="6">Jun</option>
            <option value="7">Jul</option>
            <option value="8">Aug</option>
            <option value="9">Sep</option>
            <option value="10">Oct</option>
            <option value="11">Nov</option>
            <option value="12">Dec</option>
        </select>
    </div>
    <div class="table-cell" style="padding-left:10px;">Day:</div>
    <div class="table-cell">
        <select id="day_list">
        </select>
    </div>
    <div class="table-cell" style="padding-left:10px;">
        <input type="button" id="update_solar_date" value="Update" />
    </div>
</div>
<div id="load_switch">
	<div>
		<div class="table-cell">Zone Load Type Switch</div>
	</div>
    <div>
    	<div class="table-cell"><input type="radio" value="heating_load" name="load_type_switch" id="heating_load"/></div>
    	<div class="table-cell"><label for="heating_load">Heating Load</label></div>
    </div>
    <div>
        <div class="table-cell"><input type="radio" value="cooling_load" name="load_type_switch" id="cooling_load"/></div>
	    <div class="table-cell"><label for="cooling_load">Cooling Load</label></div>
    </div>
    <br/>
    <div id="lengend_box">
    	<table>
    		<tr><td class="lengend_cell" id="lengend_1"></td><td id="red_value"></td></tr>
    		<tr><td class="lengend_cell" id="lengend_2"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_3"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_4"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_5"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_6"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_7"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_8"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_9"></td><td></td></tr>
    		<tr><td class="lengend_cell" id="lengend_10"></td><td id="green_value"></td></tr>
    	</table>
    </div>
</div>
<div id="solor_adjust">
    <div class="table-cell">Hour of day (<span id="hour_display"></span>): </div>
    <div class="table-cell"><input type="range" min="0" max="23" value="12" id="hour_bar" step="1" /></div>
</div>
<div id="inset"></div>
<h2 id='prompt'>Loading energy model ...</h2>
<div id="switches" style="display:none;">
    <input type="button" value="Floors" target="floors" class="view_switch_btn" />
</div>
<div id='hierarchy' style="width:100%;">
    <div style="width:49%;display:inline-block;" class="col-md-3 panel-body center-block">
        <label class='row'><b></b></label><br/>
        <div id="toggle_shading_container" style="display:none;">
        	<button id="toggle_shading" class="cur_show">Toggle Surround Shading</button>
        </div>
        <div id="tree_container">
             <div id='jstree'></div>
         </div>
    </div>
    <div style="width:49%;display:inline-block;" class="col-md-3 panel-body center-block">
        <div id='material_panel' style='height:50%;overflow:auto;' class="col-md-12 row"></div>
        <div id='changeMaterial' style='height:50%;overflow:auto;' class="col-md-12 row"></div>
    </div>
</div>

<script type="text/javascript" src="temp/geometry.js"></script>
<script type="text/javascript" src="temp/hvac.js"></script>
<script type="text/javascript" src="temp/envelope.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/jstree/jstree.min.js"></script>
<script src="js/geometry/three.min.js"></script>
<script src="js/geometry/OrbitControls.js"></script>
<script src="js/geometry/earcut.js"></script>
<script src="js/geometry/triangulation.js"></script>
<script src="js/geometry/three.status.min.js"></script>
<script type="x-shader/x-vertex" id="vertexShader">
    varying vec3 vWorldPosition;
    void main() {
        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
</script>
<script type="x-shader/x-fragment" id="fragmentShader">
    uniform vec3 topColor;
    uniform vec3 bottomColor;
    uniform float offset;
    uniform float exponent;

    varying vec3 vWorldPosition;

    void main() {
        float h = normalize( vWorldPosition + offset ).y;
        gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h , 0.0), exponent ), 0.0 ) ), 1.0 );
    }
</script>
<script type="x-shader/x-fragment" id="line_fragmentShader">
    void main()	{
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	}
</script>
<script type="x-shader/x-fragment" id="wall_fragmentShader">
    void main()	{
		gl_FragColor = vec4(0.4, 0.4, 0.4, 1.0);
	}
</script>
<script type="x-shader/x-fragment" id="inner_wall_fragmentShader">
    void main()	{
		gl_FragColor = vec4(0.7, 0.7, 0.7, 1.0);
	}
</script>
<script type="x-shader/x-fragment" id="floor_fragmentShader">
    void main()	{
		gl_FragColor = vec4(0.4, 0.4, 0.4, 1.0);
	}
</script>
<script type="x-shader/x-fragment" id="roof_fragmentShader">
    void main()	{
		gl_FragColor = vec4(0.59, 0.68, 0.75, 1.0);
	}
</script>
<script type="x-shader/x-fragment" id="ceiling_fragmentShader">
    void main()	{
		gl_FragColor = vec4(0.59, 0.68, 0.75, 1.0);
	}
</script>
<script type="x-shader/x-fragment" id="windoor_fragmentShader">
    void main()	{
		gl_FragColor = vec4(1.0, 1.0, 1.0, 0.1);
	}
</script>
<script type="text/javascript">
var controls, renderer, renderer2, camera, camera2, offsetX, offsetY, scene, scene2, stats;
var raycaster, mouse = new THREE.Vector2(), INTERSECTED;
var CANVAS_WIDTH = 100,
    CANVAS_HEIGHT = 100,
    CAM_DISTANCE = 150;
var geometry, line_geometry, layerStructs, controls, selected_node;
var constructs, materials, glazings, dirLight;
var layerHide={}, materialSelectMap={};
var arrayCollection=[], floorCollection=[];

var hvacZonings = {}, hvacZoningTrees = {}, hvacZoningCounts = {}, hvacZoneBasedInfo = {}, hvac_sub_systems = {};
var hvacZoningMethod;

var hasShading = false;

var hightlightmaterial, 
    lastClickedGeometry, 
    markermaterial, 
    wallMaterial, 
    innerWallMaterial,
    floorMaterial,    
    ceilingMaterial, 
    roofMaterial, 
    winDoowMaterial,
    meshFaceMaterial;
    
var solar_intensity = [0.04,0.12,0.20,0.28,0.36,0.44,0.52,0.6,0.68,0.76,0.84,0.92,1,0.92,0.84,0.76,0.68,0.60,0.52,0.44,0.36,0.28,0.20,0.12];
var solar_setting;

var zone_loads;

var project_id, branch_id, commit_id;

$(function(){
    THREE.Triangulation.setLibrary('earcut');

    //Load scene
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog( 0xffffff, 1, 5000 );
    scene.fog.color.setHSL( 0.6, 0, 1 );
    
    //renderer
    var canvas = document.getElementById("geometry");
    var canvasWidth = document.getElementById("geometry_wrapper").offsetWidth;
    
    renderer = new THREE.WebGLRenderer({ alpha:1, antialias: true });
    renderer.sortObjects = false;
    renderer.setSize(canvasWidth, 500);
    renderer.setClearColor( scene.fog.color );
    renderer.physicallyBasedShading = true;
    renderer.gammaInput = true;
    renderer.gammaOutput = true;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.renderReverseSided = false;
    canvas.parentNode.replaceChild(renderer.domElement, canvas);
    
    //camera
    camera = new THREE.PerspectiveCamera(50, canvasWidth/500, 1, 2000 );
    camera.position.set(-35, -50, 15);
    camera.up = new THREE.Vector3(0,0,1);
    scene.add( camera );
    
    // raycaster
    raycaster = new THREE.Raycaster();
    
    ////////////////LIGHTING//////////////////////////////
    var hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
    hemiLight.color.setHSL( 0.6, 1, 0.6 );
    hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
    hemiLight.position.set( 0, 100, 0 );
    scene.add( hemiLight );

    dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
    dirLight.color.setHSL( 0.1, 1, 0.95 );
    dirLight.position.set( 0, 1, 1 );
    dirLight.position.multiplyScalar( 50 );
    scene.add( dirLight );
    // dirLight.shadowCameraVisible = true;

    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;

    var d = 50;
    dirLight.shadow.camera.left = -d;
    dirLight.shadow.camera.right = d;
    dirLight.shadow.camera.top = d;
    dirLight.shadow.camera.bottom = -d;
    dirLight.shadow.camera.far = 3500;
    dirLight.shadow.bias = -0.0001;
    dirLight.shadowDarkness = 0.35;
    ////////////////LIGHTING//////////////////////////////
    
    /////////////////////SKY/////////////////////////////
    var vertexShader = document.getElementById( 'vertexShader' ).textContent;
    var fragmentShader = document.getElementById( 'fragmentShader' ).textContent;
    var uniforms = {
        topColor:    { value: new THREE.Color( 0x0077ff ) },
        bottomColor: { value: new THREE.Color( 0xffffff ) },
        offset:      { value: 33 },
        exponent:    { value: 0.6 }
    };
    uniforms.topColor.value.copy( hemiLight.color );
    scene.fog.color.copy( uniforms.bottomColor.value );
    var skyGeo = new THREE.SphereGeometry( 4000, 32, 15 );
    var skyMat = new THREE.ShaderMaterial({
    	vertexShader: vertexShader, 
    	fragmentShader: fragmentShader, 
    	uniforms: uniforms, 
    	side: THREE.FrontSide });
    var sky = new THREE.Mesh( skyGeo, skyMat );
    scene.add( sky );
    /////////////////////SKY/////////////////////////////
    
    ////////////////////GROUND//////////////////////////
    var groundGeo = new THREE.PlaneBufferGeometry( 10000, 10000 );
    var groundMat = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x050505 } );
    groundMat.color.setHSL( 0.31, 1, 0.75 );
    groundMat.side = THREE.DoubleSide;
    groundMat.transparent = true;
    groundMat.opacity = 0.7;
    
    var ground = new THREE.Mesh( groundGeo, groundMat );
    ground.position.z = 0;
    ground.receiveShadow = true;
    ground.castShadow = true;
    scene.add( ground );
    ////////////////////GROUND//////////////////////////
    
    // controls
    controls = new THREE.OrbitControls( camera, renderer.domElement );
    controls.target.set( 0, 0, 0 );
    controls.rotateSpeed = 1;
    
    // texture loader
    var textureLoader = new THREE.TextureLoader();
    var maxAnisotropy = renderer.getMaxAnisotropy();
    
    var wall_texture = textureLoader.load( "./3D/wall_texture.gif" );
    wall_texture.anisotropy = maxAnisotropy;
    wall_texture.wrapS = wall_texture.wrapT = THREE.RepeatWrapping;
    wall_texture.repeat.set( 1, 1 );
    //wallMaterial = new THREE.MeshBasicMaterial( { color: 0xffffff, map: wall_texture } );
    
    wallMaterial = new THREE.MeshPhongMaterial( { color: 0x666666} );
    
    /* 
    wallMaterial = new THREE.ShaderMaterial( {
		vertexShader: document.getElementById( 'vertexShader' ).textContent,
		fragmentShader: document.getElementById( 'wall_fragmentShader' ).textContent
	});
    //*/
    wallMaterial.side = THREE.DoubleSide;
    
    innerWallMaterial = new THREE.MeshPhongMaterial( { color: 0xB2B2B2} );
    
    /* 
    innerWallMaterial = new THREE.ShaderMaterial( {
		vertexShader: document.getElementById( 'vertexShader' ).textContent,
		fragmentShader: document.getElementById( 'inner_wall_fragmentShader' ).textContent
	}); 
    //*/
    innerWallMaterial.side = THREE.DoubleSide;
    
    var floor_texture = textureLoader.load( "./3D/floor_texture.gif" );
    floor_texture.anisotropy = maxAnisotropy;
    floor_texture.wrapS = floor_texture.wrapT = THREE.RepeatWrapping;
    floor_texture.repeat.set( 1, 1 );
    //floorMaterial = new THREE.MeshBasicMaterial( { color: 0xffffff, map: floor_texture } );
    
    floorMaterial = new THREE.MeshPhongMaterial( { color: 0x666666} );
    
    /* 
    floorMaterial = new THREE.ShaderMaterial( {
		vertexShader: document.getElementById( 'vertexShader' ).textContent,
		fragmentShader: document.getElementById( 'floor_fragmentShader' ).textContent
	}); 
    //*/
    floorMaterial.side = THREE.BackSide;
    
    var roof_texture = textureLoader.load( "./3D/roof_texture.gif" );
    roof_texture.anisotropy = maxAnisotropy;
    roof_texture.wrapS = roof_texture.wrapT = THREE.RepeatWrapping;
    roof_texture.repeat.set( 1, 1 );
    //roofMaterial = new THREE.MeshBasicMaterial( { color: 0xffffff, map: roof_texture } );
    
    roofMaterial = new THREE.MeshPhongMaterial( { color: 0x96AEBE } );
    
    /* 
    roofMaterial = new THREE.ShaderMaterial( {
		vertexShader: document.getElementById( 'vertexShader' ).textContent,
		fragmentShader: document.getElementById( 'roof_fragmentShader' ).textContent
	}); 
    //*/
    roofMaterial.side = THREE.DoubleSide;
    
    var ceiling_texture = textureLoader.load( "./3D/ceiling_texture.gif" );
    ceiling_texture.anisotropy = maxAnisotropy;
    ceiling_texture.wrapS = ceiling_texture.wrapT = THREE.RepeatWrapping;
    ceiling_texture.repeat.set( 1, 1 );
    //ceilingMaterial = new THREE.MeshBasicMaterial( { color: 0xffffff, map: ceiling_texture } );
    
    ceilingMaterial = new THREE.MeshPhongMaterial( { color: 0x96AEBE } );
    
    /* 
    ceilingMaterial = new THREE.ShaderMaterial( {
		vertexShader: document.getElementById( 'vertexShader' ).textContent,
		fragmentShader: document.getElementById( 'ceiling_fragmentShader' ).textContent
	}); 
    //*/
    ceilingMaterial.side = THREE.FrontSide;
    
    //*
    winDoorMaterial = new THREE.MeshPhongMaterial({color:0xffffff});
    winDoorMaterial.transparent = true;
    winDoorMaterial.opacity = 0.1;
    //*/
    
    /* 
    winDoorMaterial = new THREE.ShaderMaterial( {
		vertexShader: document.getElementById( 'vertexShader' ).textContent,
		fragmentShader: document.getElementById( 'windoor_fragmentShader' ).textContent
	}); 
    //*/
    winDoorMaterial.side = THREE.DoubleSide;
    
    //meshFaceMaterial = new THREE.MeshFaceMaterial( [wallMaterial, innerWallMaterial, floorMaterial, roofMaterial, ceilingMaterial, winDoorMaterial] )
    meshFaceMaterial = new THREE.MeshFaceMaterial( [wallMaterial] );
    
    //highlight material for zone
    zoneHightLightmaterial = new THREE.MeshBasicMaterial({color:0x0c578b});
    zoneHightLightmaterial.side = THREE.DoubleSide;
    zoneHightLightmaterial.transparent = true;
    zoneHightLightmaterial.opacity = 0.7;
    zoneHightLightmaterial.overdraw = true;

    //MultiplyBlending
    zoneHightLightmaterial.blending=THREE["MultiplyBlending"];

    markermaterial = new THREE.MeshBasicMaterial({color:0x999999});
    markermaterial.side = THREE.DoubleSide;
    
    //highlight material for wall
    hightlightmaterial = new THREE.MeshBasicMaterial({color:0xFE2E2E});
    hightlightmaterial.side = THREE.DoubleSide;
    hightlightmaterial.transparent = true;
    hightlightmaterial.opacity = 0.7;
    hightlightmaterial.overdraw = true;
    
    //FPS
    //stats = new Stats();
    //document.getElementById('geometry_wrapper').appendChild( stats.dom );
    
    //axis small window
    container2 = document.getElementById('inset');
    renderer2 = new THREE.WebGLRenderer();
    renderer2.setClearColor( 0xf0f0f0, 1 );
    renderer2.setSize( CANVAS_WIDTH, CANVAS_HEIGHT );
    container2.appendChild( renderer2.domElement );
    scene2 = new THREE.Scene();
    camera2 = new THREE.PerspectiveCamera( 50, CANVAS_WIDTH / CANVAS_HEIGHT, 1, 1000 );
    camera2.up = camera.up;
    axes2 = new THREE.AxisHelper( 100 );
    scene2.add( axes2 );
    animate();
    
    axes2.scale.z = 0.5;
    
    window.addEventListener('resize', function() {
        var WIDTH = document.getElementById("geometry_wrapper").offsetWidth,
            HEIGHT = 500;
        renderer.setSize(WIDTH, HEIGHT);
        camera.aspect = WIDTH / HEIGHT;
        camera.updateProjectionMatrix();
    });
    
    window.addEventListener('mousemove', function(event){
    	var WIDTH = document.getElementById("geometry_wrapper").offsetWidth,
        	HEIGHT = 500;
    	mouse.x = ( event.clientX / WIDTH ) * 2 - 1;
		mouse.y = - ( event.clientY / HEIGHT ) * 2 + 1;
    });
    
    var caseInsensitiveStringInArray = function(val, arr) {
        var res = false;
        $.each(arr, function(i, v){
            if(v.toLowerCase()===val.toLowerCase()){
                res = true;
                return;
            }
        });
        return res;
    }
    
    //process geometry data
    
    hvacZonings = sourceGeometry['hvacZonings'];
    hvacZoneBasedInfo = sourceGeometry['hvac_zone_based_info'];
    $.each(hvacZonings, function(name, controls){
        var count = 0;
        var trees = [];
        
        $.each(controls, function(idx, control){
        	var type = control['type'];
            trees.push({"id":""+idx+"", "parent":"#", "text":""+control['name']+"", "li_attr":{"type":type+"_datum", "layer":""+idx+""}});
            count = idx;
        });
        
        hvacZoningTrees[name] = trees;
        hvacZoningCounts[name] = count+1;
        
        $("#switches").append('<input type="button" value="'+name+'" target="'+name+'" class="view_switch_btn" />');
    });
    
    var geoData = sourceGeometry['data'];
    passGeometry(geoData["geometry"]);
    
    eval(geoData["javascript"]);
    
    animate();    
    
    var envelopData = sourceEnvelope['data'];
                        
    var constructs = envelopData["materials"]["constructs"];
    var materials = envelopData["materials"]["materials"];
                        
    var totalNodeCount = 0;
    var lvl1Pointer = 0;
    var lvl2Pointer = 0;
    var zones=envelopData["zones"];
                        
    $.each(layerStructs, function(index, value){
      arrayCollection.push({"id":""+totalNodeCount+"", "parent":"#", "text":""+index+"", "li_attr":{"type":"datum", "layer":""+index+""}});
      totalNodeCount++;
    });

    $.each(zones, function(i, zone){
      	var zoneList = "";
                            
      // floor based
    	$.each(layerStructs, function(index, value){
        	zoneList = value.split("&");
            var temp = zoneList.pop();  // last of zoneList is not zone name, it's layer index
            if(caseInsensitiveStringInArray(zone["zoneName"], zoneList)){
            	arrayCollection.push({"id":""+totalNodeCount+"", "parent":temp, "text":""+zone["zoneName"]+"", "li_attr":{"type":"zone", "zone":""+zone["zoneName"]+""}});
                lvl1Pointer = totalNodeCount;
                totalNodeCount++;
                if(zone.hasOwnProperty('surfaces')){
                    var surfaces = zone["surfaces"];
                    $.each(surfaces, function(j, surface){
                    	arrayCollection.push({"id":""+totalNodeCount+"", "parent":""+lvl1Pointer+"", "text":""+surface["surfaceName"]+"", "li_attr":{"type":"wall", "surface":""+surface["surfaceName"]+"", "construct":""+surface["surfaceConstruction"]+""}});
                        lvl2Pointer = totalNodeCount;
                        totalNodeCount++;
                        if(surface.hasOwnProperty('fenestrations')){
                        	var fenestrations = surface['fenestrations']
                        	$.each(fenestrations, function(k, fenestration){
                            	arrayCollection.push({"id":""+totalNodeCount+"", "parent":""+lvl2Pointer+"", "text":""+fenestration["fenestrationName"]+"", "li_attr":{"type":"fenestration", "surface":""+fenestration["fenestrationName"]+"", "construct":""+fenestration["fenestrationConstruction"]+""}});
                                totalNodeCount++;
                            });
                        }
                      });
                 }
            }
        });
                            
        //hvac zoning based
        $.each(hvacZonings, function(name, controls){
        	var trees = hvacZoningTrees[name];
        	var count = hvacZoningCounts[name];
                                
        	$.each(controls, function(idx, control){
            	zoneList = control['zones'].split("&");
            	var type = control['type'];
                                    
             	if(caseInsensitiveStringInArray(zone["zoneName"], zoneList)){
                	trees.push({"id":""+count+"", "parent":idx, "text":""+zone["zoneName"]+"", "li_attr":{"type":type+"_zone", "zone":""+zone["zoneName"]+""}});
                	lvl1Pointer = count;
                	count++;
                }
             });
                                
             hvacZoningTrees[name] = trees;
             hvacZoningCounts[name] = count;
        });
     });
                        
     floorCollection = arrayCollection;
     $('#jstree').jstree({
        'core': {
            'data': floorCollection,
            "multiple":false,
            "themes" : {
            	"icons":false
                  		}
                 }
     });
                        
     if(hasShading){
      $("#toggle_shading_container").show();
     }
     
     $('#prompt').remove();
     $("#switches").show();
    
    
    $("#switches").on('click', '.view_switch_btn', function(){
        var target = $(this).attr('target');
        
        //hide material panel
        $("#material_panel, #changeMaterial").html("");
        
        dehighlight();
        
        if(target==='floors'){
        	if(hasShading){
        		$("#toggle_shading_container").show();
            	visibilityControl("LEVEL_-1", true, true);
            	if(!$("#toggle_shading").hasClass("cur_show")){
            		$("#toggle_shading").addClass("cur_show");
            	}
        	}
        	
        	
            //show whole building
            $.each(layerStructs, function(index, value){
                visibilityControl(index, true, true);
            });
            
            $("#jstree").jstree("destroy").empty();
            $('#jstree').jstree({
                'core': {
                    'data': floorCollection,
                    "multiple":false,
                    "themes" : {
                        "icons":false
                      }
                }
            });        
            $("#jstree").jstree(true).refresh(true);
            
            //TODO: duplicated code block
            $('#jstree').on('activate_node.jstree', function(e, data){
                var node = data.node;
                
                //click on a zone, surface, fenestration label
                var showRoof = false;
                if(node.li_attr.type != 'datum'){
                    while(node.parent != "#"){
                        node = $('#jstree').jstree(true).get_node ($('#jstree').jstree(true).get_parent(node));
                    }
                    
                    //only show the current datum
                    $.each(layerStructs, function(index, value){
                        visibilityControl(index, false, false);
                    });
                }
                else{
                    selected_node = node;
                    
                    //click on a visible datum label
                    if(!layerHide[node.text]){
                        //toggle visibility
                        $.each(layerStructs, function(index, value){
                            if(layerHide[index]){
                                showRoof = true;
                                visibilityControl(index, true, true);
                            }else {
                                visibilityControl(index, false, false);
                            }
                        });
                    }
                    //click on a hidden datum label
                    else{
                        // hide all first
                        $.each(layerStructs, function(index, value){
                            visibilityControl(index, false, false);
                        });
                    }
                }
                //display the selected datum
                visibilityControl(node.text, true, showRoof);
                
                geometryClick($(this));
                var zone = data.node.li_attr.zone;
                var surface = data.node.li_attr.surface;
                var type = data.node.li_attr.type;
                $("#material_panel, #changeMaterial").html("");
                if(zone){
                    var surfaces = geometry["ZONE_"+zone.toLowerCase()];
                    $.each(surfaces, function(index, data){
                        highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
                    });
                }
                if(surface){
                    var surfaceInfo = geometry["SURFACE_"+surface];
                    highlight(surfaceInfo, "highlight", 1, undefined);
                    
                    var zone_attr = $('#'+data.node.parent).attr('zone');
                    if(zone_attr){
                        var feneZone = geometry["ZONE_"+zone_attr.toLowerCase()];
                        if(feneZone){
                            $.each(feneZone, function(index, data){
                                if (index!=surface){
                                    highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
                                }
                                
                            });
                        }
                    }
                    
                    var construct = data.node.li_attr.construct;
                    var type = data.node.li_attr.type;
                    var info = constructs[construct];
                    
                    var materialTable = $("<table class='table table-striped'>" +
                                "<tr>" +
                                    "<td>Construct Name:</td>" +
                                    "<td>"+info["Name"]+"</td>" +
                                "</tr>" +
                                "<tr>" +
                                    "<td class='layer' layerOrder='OutsideLayer'>Outside Layer:</td>" +
                                    "<td class='info_data col-md-6'>"+info["Outside Layer"]+"</td>" +
                                "</tr>" +
                            "</table>");
                    var i=2;
                    var content;
                    while(true){
                        content = info["Layer "+i];
                        if(content !== undefined){
                            $("<tr><td class='layer' layerOrder='Layer"+i+"'>Layer"+i+":</td><td class='info_data col-md-6'>"+content+"</td></tr>").appendTo($(materialTable));
                            i++;
                        }else {
                            break;
                        }
                    }
                    $(materialTable).appendTo($('#material_panel'));
                    
                }else {
                    //$(".info_data").click(function(){});
                }
            });
            
            return;
        }else {
        	if(hasShading){
        		$("#toggle_shading_container").hide();
            	visibilityControl("LEVEL_-1", false, true);
        	}
        	
        	
            //show lines only
            $.each(layerStructs, function(index, value){
                showLines(index);
            });
        }
        
        var tree = hvacZoningTrees[target];
        $("#jstree").jstree("destroy").empty();
        $('#jstree').jstree({
            'core': {
                'data': tree,
                "multiple":false,
                "themes" : {
                    "icons":false
                  }
            }
        });        
        $("#jstree").jstree(true).refresh(true);
        
        hvacZoningMethod = target;
        
        // hvac listeners
        $('#jstree').on('select_node.jstree', function(e, data){
            var node = data.node;
            //console.log(data.node);
    
            geometryClick($(this));
            var datum=data.node.li_attr.datum;
            var zone = data.node.li_attr.zone;
            var surface = data.node.li_attr.surface;
            var type = data.node.li_attr.type;
            $("#material_panel, #changeMaterial").html("");
            
            if(type.indexOf("datum")>0){
                var zonings = hvacZonings[hvacZoningMethod];
                
                $.each(zonings, function(idx, zoning){
                    if(zoning['name'] === node.text){
                        var zoneList = zoning['zones'].split('&');
                        $.each(zoneList, function(i, v){
                            var surfaces = geometry["ZONE_"+v.toLowerCase()];
                            $.each(surfaces, function(index, data){
                                highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
                            });
                        });
                    }
                });
                
                if(type==='system_datum'){
                	$.ajax({
                		type: 'POST',
                		url: './ViewerHVACSystemZone',
                		data: {'system_type': target,
                			   'system_name': node.text,
                			   'commit_id': commit_id},
                		success: function(data){
                			if (data["redirect"]) {
                                window.location.href = data["location"];
                                return;
                            }
                            
                            if(data['status']==='success'){
                                var data = data['data'];
                                if(data['error_msg']){
                                	alert(data['error_msg']);
                                	return;
                                }
                                
                                var sub_systems = $("<table class='table table-striped'>" +
                                        "<tr>" +
                                            "<th>Sub system type</th>" +
                                            "<th>Sub system name</th>" +
                                        "</tr>" +
                                    "</table>");
	                            var i=2;
	                            
	                            var systems = data['system'];
	                            hvac_sub_systems = {};
	                            $.each(systems, function(i, sys){
	                            	var sub_sys_type = sys['properties']['name'];
	                            	var sub_sys_name = sys['properties']['properties'][0]['value'];
	                            	$("<tr><td class='col-md-6'><b>"+sub_sys_type+"</b></td><td class='hvac_sys_info_data col-md-6'>"+sub_sys_name+"</td></tr>").appendTo($(sub_systems));
	                            	
	                            	hvac_sub_systems[sub_sys_name] = sys['properties']['properties'];
	                            });
	                            $(sub_systems).appendTo($('#material_panel'));
                            }else {
                                alert(data['error_msg']);
                            }
                		},
                		dataType: 'json'
                	});
                }else if(type === 'zone_datum'){
					$('#changeMaterial').html("");
                	
                	var info = hvacZoneBasedInfo[node.text]['properties'];
                	var html = "<table class='table table-striped'>";
                    $.each(info, function(index, value){
                    	var name = value['name'];
                    	var val = value['value'];
                    	var unit = value['unit'];
                    	if(unit!==''){
                    		val = val + ' ('+unit+')';
                    	}
                        html+="<tr><td class='col-md-6'><b>"+name+"</b></td><td class='col-md-6'>"+val+"</td></tr>";
                    });
                    
                    html += "</table>";
                    
                    $('#changeMaterial').append(html);
                }
            }else if(zone){
                var surfaces = geometry["ZONE_"+zone.toLowerCase()];
                $.each(surfaces, function(index, data){
                    highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
                });
                
                if(type==='system_zone'){
                	console.log(data.instance.get_node(data.node.parent).text);
                	$.ajax({
                		type: 'POST',
                		url: './ViewerHVACSystemZone',
                		data: {'system_type': target,
                			   'system_name': data.instance.get_node(data.node.parent).text,
                			   'zone': node.text,
                			   'commit_id': commit_id},
                		success: function(data){
                			if (data["redirect"]) {
                                window.location.href = data["location"];
                                return;
                            }
                            
                            if(data['status']==='success'){
                            	var data = data['data'];
                            	if(data['error_msg']){
                            		alert(data['error_msg']);
                            		return;
                            	}
                            	
                                var data = data['zone'][0]['properties'];
                                
                                $('#changeMaterial').html("");
                            	
                                var html = "<h4>Zone System Type: "+data['name']+"</h4>"
                            	html += "<table class='table table-striped'>";
                                $.each(data['properties'], function(index, value){
                                	var name = value['name'];
                                	var val = value['value'];
                                	var unit = value['unit'];
                                	if(unit!==''){
                                		val = val + ' ('+unit+')';
                                	}
                                    html+="<tr><td class='col-md-6'><b>"+name+"</b></td><td class='col-md-6'>"+val+"</td></tr>";
                                });
                                
                                html += "</table>";
                                
                                $('#changeMaterial').append(html);
                            }else {
                                alert(data['error_msg']);
                            }
                		},
                		dataType: 'json'
                	});
                }
            }
            /* 
            if(surface){
                var surfaceInfo = geometry["SURFACE_"+surface];
                highlight(surfaceInfo, "highlight", 1, undefined);
                
                var zone_attr = $('#'+node.parent).attr('zone');
                if(zone_attr){
                    var feneZone = geometry["ZONE_"+zone_attr.toLowerCase()];
                    if(feneZone){
                        $.each(feneZone, function(index, data){
                            if (index!=surface){
                                highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
                            }
                            
                        });
                    }
                }
                
                var construct = data.node.li_attr.construct;
                var type = data.node.li_attr.type;
                var info = constructs[construct];
                
                var materialTable = $("<table class='table table-striped'>" +
                            "<tr>" +
                                "<td>Construct Name:</td>" +
                                "<td>"+info["Name"]+"</td>" +
                            "</tr>" +
                            "<tr>" +
                                "<td class='layer' layerOrder='OutsideLayer'>Outside Layer:</td>" +
                                "<td class='info_data col-md-6'>"+info["Outside Layer"]+"</td>" +
                            "</tr>" +
                        "</table>");
                var i=2;
                var content;
                while(true){
                    content = info["Layer "+i];
                    if(content !== undefined){
                        $("<tr><td class='layer' layerOrder='Layer"+i+"'>Layer"+i+":</td><td class='info_data col-md-6'>"+content+"</td></tr>").appendTo($(materialTable));
                        i++;
                    }else {
                        break;
                    }
                }
                $(materialTable).appendTo($('#material_panel'));
                
            }else {
                //$(".info_data").click(function(){});
            }
            */
        });
    });
    
    //bold the text of changeable material to provide a better interaction experience
    $('body').on('mouseenter', '.info_data', function(){
        $(this).css('font-weight', 'bold');
    });
    $('body').on('mouseleave', '.info_data', function(){
        $(this).css('font-weight', 'normal');
    });
    
    $('body').on('mouseenter', '.hvac_sys_info_data', function(){
        $(this).css('font-weight', 'bold');
    });
    $('body').on('mouseleave', '.hvac_sys_info_data', function(){
        $(this).css('font-weight', 'normal');
    });
    
    //for zone highlight
    $('body').on('mouseenter', '.dbmaterial', function(){
        $(this).addClass("highlight2");
    });
    $('body').on('mouseleave', '.dbmaterial', function(){
        $(this).removeClass("highlight2");
    });
    
    //on click changeable material name, pull on material info
    $('body').on('click', '.info_data', function(){
        html: getMaterialDetailedInfo($(this).text().trim(),$(this).closest('tr').find('.layer').attr('layerOrder'))
    });
    
    $('body').on('click', '.hvac_sys_info_data', function(){
    	var sub_sys_name = $(this).text().trim();
    	var info = hvac_sub_systems[sub_sys_name];
    	
    	$('#changeMaterial').html("");
    	
    	var html = "<table class='table table-striped'>";
        $.each(info, function(index, value){
        	var name = value['name'];
        	var val = value['value'];
        	var unit = value['unit'];
        	if(unit!==''){
        		val = val + ' ('+unit+')';
        	}
            html+="<tr><td class='col-md-6'><b>"+name+"</b></td><td class='col-md-6'>"+val+"</td></tr>";
        });
        
        html += "</table>";
        
        $('#changeMaterial').append(html);
    });
    
    // original section
    $('#jstree').on('activate_node.jstree', function(e, data){
        var node = data.node;
        
        //click on a zone, surface, fenestration label
        var showRoof = false;
        if(node.li_attr.type != 'datum'){
            while(node.parent != "#"){
                node = $('#jstree').jstree(true).get_node ($('#jstree').jstree(true).get_parent(node));
            }
            
            //only show the current datum
            $.each(layerStructs, function(index, value){
                visibilityControl(index, false, false);
            });
        }else {
            selected_node = node;
            
            //click on a visible datum label
            if(!layerHide[node.text]){
                //toggle visibility;
                $.each(layerStructs, function(index, value){
                    if(layerHide[index]){
                        showRoof = true;
                        visibilityControl(index, true, true);
                    }else {
                        visibilityControl(index, false, false);
                    }
                });
            }
            //click on a hidden datum label
            else{
                // hide all first
                $.each(layerStructs, function(index, value){
                    visibilityControl(index, false, false);
                });
            }
        }
        
        //display the selected datum
        visibilityControl(node.text, true, showRoof);
        
        geometryClick($(this));
        var zone = data.node.li_attr.zone;
        var surface = data.node.li_attr.surface;
        var type = data.node.li_attr.type;
        $("#material_panel, #changeMaterial").html("");
        if(zone){
            var surfaces = geometry["ZONE_"+zone.toLowerCase()];
            $.each(surfaces, function(index, data){
                highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
            });
        }
        if(surface){
            var surfaceInfo = geometry["SURFACE_"+surface];
            highlight(surfaceInfo, "highlight", 1, undefined);
            
            var zone_attr = $('#'+data.node.parent).attr('zone');
            if(zone_attr){
                var feneZone = geometry["ZONE_"+zone_attr.toLowerCase()];
                if(feneZone){
                    $.each(feneZone, function(index, data){
                        if (index!=surface){
                            highlight(geometry["SURFACE_"+index], "highlight2", 1, undefined);
                        }
                        
                    });
                }
            }
            
            var construct = data.node.li_attr.construct;
            var type = data.node.li_attr.type;
            var info = constructs[construct];
            
            var materialTable = $("<table class='table table-striped'>" +
                        "<tr>" +
                            "<td>Construct Name:</td>" +
                            "<td>"+info["Name"]+"</td>" +
                        "</tr>" +
                        "<tr>" +
                            "<td class='layer' layerOrder='OutsideLayer'>Outside Layer:</td>" +
                            "<td class='info_data col-md-6'>"+info["Outside Layer"]+"</td>" +
                        "</tr>" +
                    "</table>");
            var i=2;
            var content;
            while(true){
                content = info["Layer "+i];
                if(content !== undefined){
                    $("<tr><td class='layer' layerOrder='Layer"+i+"'>Layer"+i+":</td><td class='info_data col-md-6'>"+content+"</td></tr>").appendTo($(materialTable));
                    i++;
                }else {
                    break;
                }
            }
            $(materialTable).appendTo($('#material_panel'));
            
        }else {
            //$(".info_data").click(function(){});
        }
    });
    
    $("#month_list").change(function(){
        set_days(parseInt($(this).val()));
    });
    
    $("#hour_bar").on("input", function(){
        set_solar($(this).val());
    });
    
    
    $("input[name='load_type_switch']").change(function(){
        dehighlight();
        
        var select = $(this).val();
        var load_data = zone_loads[select];
        
        var level = selected_node.text;
        var zones = geometry["DATUM_STRUCTS"][level].split('&');
        for(var i=0;i<zones.length-1;i++){
            var zone = zones[i];
            var color = load_data[zone+"_color"];
            var surfaces = geometry["ZONE_"+zone.toLowerCase()];
            $.each(surfaces, function(index, data){
                highlight(geometry["SURFACE_"+index], "highlight2", -1, color);
            });
        }
        
        if(select === 'heating_load'){
        	$("#red_value").html(zone_loads['heating_min']+'W');
        	$("#green_value").html(zone_loads['heating_max']+'W');
        }else if(select === 'cooling_load'){
        	$("#red_value").html(zone_loads['cooling_max']+'W');
        	$("#green_value").html(zone_loads['cooling_min']+'W');
        }
        $("#lengend_box").show();
    });
    
    $("button[id=toggle_shading]").click(function(){
    	if(hasShading){
    		if($(this).hasClass("cur_show")){
        		visibilityControl("LEVEL_-1", false, true);
        	}else {
        		visibilityControl("LEVEL_-1", true, true);
        	}
        	
        	$(this).toggleClass("cur_show");
    	}
    });
});

function set_days(month){
    $("#day_list").html("");
    var days = 30;
    switch(month){
        case 1:
        case 3:
        case 5:
        case 7:
        case 8:
        case 10:
        case 12:
            days = 31;
            break;
        case 2:
            days = 28;
            break;
    }
    
    for(var i=1;i<=days;i++){
        $("#day_list").append("<option value='"+i+"'>"+i+"</option>");
    }
}

function set_solar(hour){
    $("#hour_display").html(hour);
        
    var solar = solar_setting[parseInt(hour)];
    
    //EnergyPlus Y-axis pointing north, X-axis pointing east
    var azimuth = parseFloat(solar["azimuth"]);
    dirLight.position.x = Math.sin(azimuth*Math.PI/180)*50;
    dirLight.position.y = Math.cos(azimuth*Math.PI/180)*50;
    
    var angle = 90-parseFloat(solar["angle"]);
    if(angle<0){
        dirLight.position.z = 0;
    }else {
        dirLight.position.z = Math.tan(angle*Math.PI/180)*50;
    }
    
    dirLight.intensity = solar_intensity[hour];
}

function visibilityControl(level, isShow, showRoof){
    var object = scene.getObjectByName( level+'_lines', true );
    object.visible = isShow;
    
    var object = scene.getObjectByName( level+'_surfaces', true );
    object.visible = isShow;
    layerHide[level] = !isShow;
    
    $.each(object.children, function(i,obj){
        if(obj.name==='merged_mesh_roof'){
            obj.visible = showRoof;
        }
    });
    
    if(showRoof){
        $("#load_switch").hide();
        $('input[name="load_type_switch"]').prop('checked', false);
        selected_node = false;
    }else {
        $("#load_switch").show();
        $("#lengend_box").hide();
        $("input[name='load_type_switch']").prop('checked', false);
    }
}

function showLines(level){
    var object = scene.getObjectByName( level+'_lines', true );
    object.visible = true;
    
    var object = scene.getObjectByName( level+'_surfaces', true );
    object.visible = false;
    
    var object = scene.getObjectByName( level+'_Roof', true );
    if(object){
        object.visible = false;
    }
}
function passGeometry(data){
    geometry = data;
    var offsets = geometry["OFFSETS"];
    layerStructs = geometry["DATUM_STRUCTS"];
    offsetX = offsets["X"];
    offsetY = offsets["Y"];
    
    $.each(layerStructs, function(index, value){
        layerHide[index] = false;
    });
}
function animate() {
    controls.update();
    
    camera2.position.copy( camera.position );
    camera2.position.sub( controls.target );
    camera2.position.setLength( CAM_DISTANCE );
    camera2.lookAt( scene2.position );
    
    //renderer.render(scene, camera);
    render();
    renderer2.render(scene2, camera2);
    
    requestAnimationFrame(animate);
    
    //stats.update();
}

function render() {
	/* raycaster.setFromCamera( mouse, camera );
	
	if(!selected_node){
		renderer.render( scene, camera );
		return;
	}
	var layer = scene.getObjectByName(selected_node.text+"_surfaces");
	if(layer===undefined){
		return;
	}
	var intersects = raycaster.intersectObjects( layer.children );
	if ( intersects.length > 0 ) {
		if ( INTERSECTED != intersects[ 0 ].object ) {
			if ( INTERSECTED != intersects[ 0 ].object ) {
				
				if ( INTERSECTED ){
					INTERSECTED.material = INTERSECTED.currentMaterial;
				}
				INTERSECTED = intersects[ 0 ].object;
				INTERSECTED.currentMaterial = INTERSECTED.material;
				
				var s_m = new THREE.MeshPhongMaterial( { color: 0xff0000 } );
				s_m.side = INTERSECTED.currentMaterial.side;
				INTERSECTED.material = s_m;
			}
		}
	} else {
		if ( INTERSECTED ){
			INTERSECTED.material = INTERSECTED.currentMaterial;
		}
		INTERSECTED = null;
	} */
	renderer.render( scene, camera );
}

//highlight a surface on click
function highlight(surface, hightlightName, hightlight_surface_offset, color){
    var num = surface["num"];
    
    //get 3D points
    var pts = [];
    var coordinates;
    for(var i=0;i<num;i++){
        coordinates = surface["POINT_"+i].split(",");
        var x = parseFloat(coordinates[0]) + offsetX;
        var y = parseFloat(coordinates[1]) + offsetY;
        pts.push(new THREE.Vector3(x, y, parseFloat(coordinates[2])));
    }
    
    //get surface normal
    var normal;
    var v1 = new THREE.Vector3(pts[0].x-pts[1].x, pts[0].y-pts[1].y, pts[0].z-pts[1].z);
    for(var i=2;i<pts.length;i++){
        var v2 = new THREE.Vector3(pts[0].x-pts[i].x, pts[0].y-pts[i].y, pts[0].z-pts[i].z);
        normal = v1.cross(v2).normalize();
        if(normal.x!==0 || normal.y!==0 || normal.z!==0){
            break;
        }
    }
    
    if(normal.x===0 && normal.y===0 && normal.z===0){
        console.error("Cannot get surface normal vector");
        return;
    }
    
    //get rotation matrix to XY plane
    var quaternion = new THREE.Quaternion().setFromUnitVectors(normal, new THREE.Vector3(0,0,1));
    var matrix = new THREE.Matrix4().makeRotationFromQuaternion(quaternion);
    
    //get 2D points on XY plane, and z value
    var pts2D = [], z;
    var n_off_x = normal.x*0.1*hightlight_surface_offset,
        n_off_y = normal.y*0.1*hightlight_surface_offset,
        n_off_z = normal.z*0.1*hightlight_surface_offset;
    $.each(pts, function(i, v){
        var v1 = new THREE.Vector3(v.x+n_off_x, v.y+n_off_y, v.z+n_off_z);
        var r = v1.applyMatrix4(matrix);
        pts2D.push(new THREE.Vector2(r.x, r.y));
        
        z = r.z;
    });
    
    // make mesh on XY plane
    var geometry = new THREE.ShapeBufferGeometry(new THREE.Shape(pts2D));
    
    var material;
    if(!color){
        material = hightlightName==='highlight' ? hightlightmaterial : zoneHightLightmaterial;
    }else {
        eval("material = new THREE.MeshBasicMaterial({color:"+color+"})");
        material.side = THREE.DoubleSide;
        material.transparent = true;
        material.opacity = 0.7;
        material.overdraw = true;
    }
    var mesh = new THREE.Mesh( geometry, material );
    
    //translate by z
    mesh.applyMatrix( new THREE.Matrix4().makeTranslation(0,0, z ));
    
    //rotate by inverse matrix
    mesh.applyMatrix( matrix.getInverse(matrix) );
    
    //show mesh
    mesh.name = hightlightName;
    scene.add(mesh);
}

//highlight a zone on click
function highlight2(surface){
    var num = surface["num"];
    
    var geo = new THREE.Geometry();
    var coordinates;
    for(var i=0;i<num;i++){
        coordinates = surface["POINT_"+i].split(",");
        var x = parseFloat(coordinates[0]) + offsetX;
        var y = parseFloat(coordinates[1]) + offsetY;
        geo.vertices.push(new THREE.Vector3(x, y, coordinates[2]));
    }
    
    for(var i=1;i+1<num;i++){
        var face = new THREE.Face3(0, i, i+1);
        geo.faces.push(face);
    }
    
    //var mesh = new THREE.Mesh(geo, zoneHightLightmaterial);
    var mesh = new THREE.Mesh(geo, wallMaterial);
    mesh.name = "highlight2";
    scene.add(mesh);
}

//reset previously selected zone/surface    
function dehighlight(){
    var remove = new Array();
    $.each(scene.children, function(index, data){
        if(data instanceof THREE.Mesh && data.name === "highlight"){
            remove.push(data);
        }
        if(data instanceof THREE.Mesh && data.name === "highlight2"){
            remove.push(data);
        }
        
        if(data instanceof THREE.Mesh && data.name === "check"){
            remove.push(data);
        }
    });
    $.each(remove, function(index, mesh){
        scene.remove(mesh);
        mesh.geometry.dispose();
    });
}

function getMaterialDetailedInfo(name, layerId){
    $('#changeMaterial').html("");
    var selectedNode = $('#jstree').jstree('get_top_selected', true);
    var surface = selectedNode[0].li_attr.surface.trim();
    var type = selectedNode[0].li_attr.type.trim();
    var constructName = selectedNode[0].li_attr.construct.trim();

    var hasRest = false;
    var modelMaterialId = constructName+"__"+layerId;
    var info = materialSelectMap[modelMaterialId];
    if(info === undefined || info["dbMaterailId"] === undefined){
        info = materials[name];
    }else {
        info = materialSelectSave[info["dbMaterailId"]];
        hasRest = true;
    }
    var html = "<table class='table table-striped'>";
    $.each(info, function(index, value){
        index = index.replace(/(?=(?!(\/)))([A-Z]{1})/g, ' $2').replace(/E P/g, 'EP');
        html+="<tr><td class='col-md-6'><b>"+index+"</b></td><td class='col-md-6'>"+value+"</td></tr>";
    });
    
    html += "</table>";
    
    activeSurface = surface;
    activeName = name;
    activeType = type;
    activeLayerId = layerId;
    activeConstruct = constructName;
    
    $('#changeMaterial').append(html);
    
    if(!hasRest){
        $('body').find('#resetMaterial').addClass('disabled');
    }
}

function geometryClick(from){
    dehighlight();
    
    lastClickedGeometry = from;
    
    var zone = $(from).attr("zone");
    var surface = $(from).attr("surface");
    var type = $(from).attr("type");
}
</script>
</body>
</html>